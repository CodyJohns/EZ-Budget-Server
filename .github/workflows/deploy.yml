name: Deploy - Restart OCI Container Instance

on:
  workflow_dispatch: {} 
  workflow_run:
    workflows: ["CI - Build & Push ezbudget_server"]
    types: [completed]

jobs:
  restart-oci-container-instance:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success') }}
    runs-on: ubuntu-latest

    steps:
      - name: Install OCI CLI
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install oci-cli

      - name: Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          cat > ~/.oci/config <<'EOF'
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF
          # If your key is passphrase-protected, also add:
          # echo "pass_phrase=${{ secrets.OCI_PRIVATE_KEY_PASS }}" >> ~/.oci/config

      - name: Restart Container Instance
        run: |
          oci --auth api_key container-instances container-instance restart \
            --container-instance-id "${{ secrets.OCI_CONTAINER_INSTANCE_ID }}"

      - name: Wait for RUNNING
        run: |
          echo "Waiting for container instance to be RUNNING..."
          for i in {1..60}; do
            STATE=$(oci container-instances container-instance get \
              --container-instance-id "${{ secrets.OCI_CONTAINER_INSTANCE_ID }}" \
              --query 'data."lifecycle-state"' --raw-output)
            echo "State: $STATE"
            if [ "$STATE" = "ACTIVE" ]; then exit 0; fi
            sleep 10
          done
          echo "Timed out waiting for RUNNING"; exit 1
