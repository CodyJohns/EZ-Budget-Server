name: Deploy - Restart OCI Container Instance

on:
  workflow_dispatch: {}
  workflow_run:
    workflows: ["CI - Build & Push ezbudget_server"]
    types: [completed]
    branches: [main, dev] # only deploy when CI ran on these branches

jobs:
  restart-oci-container-instance:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Install OCI CLI
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install oci-cli

      - name: Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          printf '%s\n' "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

          cat > ~/.oci/config <<'EOF'
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF

      - name: Restart Container Instance
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref_name }}"
          if [[ "$BRANCH" == "main" ]]; then
            CONTAINER_ID="${{ secrets.PROD_CONTAINER_INSTANCE_ID }}"
          else
            CONTAINER_ID="${{ secrets.STAGING_CONTAINER_INSTANCE_ID }}"
          fi

          if [[ -z "$CONTAINER_ID" ]]; then
            echo "ERROR: CONTAINER_ID is empty." >&2
            exit 1
          fi

          oci --auth api_key container-instances container-instance restart \
            --container-instance-id "$CONTAINER_ID"

      - name: Wait for ACTIVE
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref_name }}"
          if [[ "$BRANCH" == "main" ]]; then
            CONTAINER_ID="${{ secrets.PROD_CONTAINER_INSTANCE_ID }}"
          else
            CONTAINER_ID="${{ secrets.STAGING_CONTAINER_INSTANCE_ID }}"
          fi

          if [[ -z "$CONTAINER_ID" ]]; then
            echo "ERROR: CONTAINER_ID is empty." >&2
            exit 1
          fi

          echo "Waiting for container instance to be ACTIVE..."
          for i in {1..60}; do
            STATE=$(oci container-instances container-instance get \
              --container-instance-id "$CONTAINER_ID" \
              --query 'data."lifecycle-state"' --raw-output)
            echo "State: $STATE"
            if [[ "$STATE" == "ACTIVE" ]]; then exit 0; fi
            sleep 10
          done
          echo "Timed out waiting for ACTIVE"; exit 1